/*! **********************************************************************************************
* 2016  ITESM Campus Guadalajara. Laboratorio de Microcontroladores 
*
* @author(s): Daniela Becerra, Jesús Barroso
*
* @brief
*Include functions to initialize TX and RX, send a message and a calback funtion to the Rx to correctly 
*store values.
*
**************************************************************************************************/


/*************************************************************************************************/
/*********************						Includes						**********************/
/*************************************************************************************************/
#include <hidef.h> /* for EnableInterrupts macro */
#include "derivative.h" /* include peripheral declarations */
#include "SCI.h"
#include "types.h"
/*************************************************************************************************/
/*********************						Defines							**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************						Typedefs						**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************					Function Prototypes					**********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Variables                    **********************/
/*************************************************************************************************/
bool bTX_IsBusy;
static char _cTxMSG[MAX_MSG_SIZE];
static u8 _u8TxSize;
static u8 _u8TxIndex;
static ISR_callback _fnRxCallback = (ISR_callback)0;
/*************************************************************************************************/
/*********************					Global Variables					**********************/
/*************************************************************************************************/

 
/*************************************************************************************************/
/*********************                  Static Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Global Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************				   Exported Functions					**********************/
/*************************************************************************************************/

/*!*-----------------------------------------------------------------------------------------------
* \name     Tx_ISR
* \brief   interruption routine to attend an overload in the counter of the mtim
* 			it resets the flag and subtracts one to the counts
* \param    void
* \return   void
-------------------------------------------------------------------------------------------------*/
interrupt VectorNumber_Vscirx void SCI_RX(void){
	__RESET_WATCHDOG();
	(void)SCIS1;
	if(_fnRxCallback){
		(*_fnRxCallback)();
	}
}

interrupt VectorNumber_Vscitx void SCI_TxISR(void)
{
	(void)SCIS1;
	if(_u8TxSize <= _u8TxIndex)
	{
		SCI_TX_INTERRUPT_DIS;
		bTX_IsBusy = FALSE;
	}
	else
	{
		SCID = _cTxMSG[_u8TxIndex++];
	}
	
}

//-------------------------------------------------------------------------------------------------

void SCI_InitTx(void)
{
	SCIBD_RATE_9600;
	SCI_ENABLE_TX;
	//SCI_TX_INTERRUPT_EN;
}

//-------------------------------------------------------------------------------------------------
void SCI_InitRx(void)
{
	SCIC2_RIE=1;
	SCIBD_RATE_9600;
	SCI_ENABLE_RX; 
	
}
//-------------------------------------------------------------------------------------------------

void SCI_SendMessage(const u8 msg[], u8 size)
{
	u8 i;
	if(bTX_IsBusy)
	{
	return;	
	}
	
	
	if(size > MAX_MSG_SIZE)
		size = MAX_MSG_SIZE;	
	
	// save data
	for(i = 0; i<size; i++)
	{
		_cTxMSG[i] = msg[i];
	}
	_u8TxSize = size;
	
	//send the first data
	
	_u8TxIndex=0;
	SCI_TX_INTERRUPT_EN;
	bTX_IsBusy = TRUE;

}

//-------------------------------------------------------------------------------------------------

bool SCI_TxIsBusy()
{
	return bTX_IsBusy;
}

//------
void SCI_SetRxCallBack(ISR_callback function){
	if(function){
		_fnRxCallback=function;
	}
	
}

//_----


char SCI_getChar(){
	return SCID;	
}
